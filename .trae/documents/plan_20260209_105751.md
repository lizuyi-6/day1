# 工作流变量传递系统实施计划

## 阶段 1: 基础数据结构

1. 创建变量类型定义文件 `types/variable.ts`
2. 创建节点接口定义文件 `types/node.ts`

## 阶段 2: 核心节点改造

1. **StartNode**: 添加输入变量配置，支持动态添加/删除变量
2. **LlmNode**: 添加明确的 inputs/outputs，支持变量引用
3. **CodeNode**: 添加 inputs/outputs 定义
4. **ConditionNode**: 添加 inputs/outputs 定义
5. 1\. 变量系统

   * 全局变量 ：整个工作流共享的变量
   * 局部变量 ：节点间传递的变量
   * 变量类型 ：string, number, boolean, object, array
   * 变量引用语法 ： ${variableName} 用于在配置中引用变量

   ### 2. 节点数据结构

   每个节点需要：

   * inputs : 输入变量数组（name, type, description, defaultValue）
   * outputs : 输出变量数组（name, type, description）
   * data : 节点配置数据

   ### 3. StartNode（开始节点）

   * 功能 ：工作流入口点
   * 输入变量 ：用户可以定义多个输入变量（如 inputText , userId ）
   * 输出 ：将输入变量传递给下一个节点
   * UI ：支持动态添加/删除输入变量

   ### 4. LlmNode（大模型节点）

   * 输入变量 ：
     * prompt : 提示词（支持变量引用，如 ${inputText} ）
     * systemPrompt : 系统提示词
     * temperature : 温度参数
     * maxTokens : 最大令牌数
   * 输出变量 ：
     * response : 模型响应
     * usage : 令牌使用量
   * UI ：显示输入/输出变量，支持变量引用语法高亮

   ### 5. CodeNode（代码节点）

   * 输入变量 ：
     * code : 代码（支持变量引用）
     * inputData : 从上游节点接收的数据
   * 输出变量 ：
     * result : 执行结果
     * error : 错误信息（如果有）

   ### 6. ConditionNode（条件节点）

   * 输入变量 ：
     * expression : 条件表达式（支持变量引用，如 ${inputData.value > 0} ）
   * 输出变量 ：
     * trueResult : 条件为真时的输出
     * falseResult : 条件为假时的输出

   ### 7. VariableNode（变量节点）

   * 输入变量 ：无
   * 输出变量 ：
     * value : 变量值（可以是固定值或变量引用）

   ### 8. KnowledgeNode（知识库节点）

   * 输入变量 ：
     * query : 查询文本（支持变量引用）
     * topK : 返回数量
   * 输出变量 ：
     * results : 查询结果数组

   ### 9. HttpRequestNode（HTTP请求节点）

   * 输入变量 ：
     * url : 请求URL（支持变量引用）
     * method : 请求方法
     * headers : 请求头
     * body : 请求体
   * 输出变量 ：
     * response : 响应数据
     * status : HTTP状态码

   ### 10. 变量传递机制

   * 边连接 ：Edge 连接节点的输入和输出
   * 自动映射 ：连接时自动映射变量
   * 变量解析 ：执行时解析 ${variableName} 引用
   * 作用域 ：变量在不同节点间的作用域管理

   ### 11. WorkflowInspector（检查器）增强

   * 输入变量面板 ：显示和编辑节点的输入变量
   * 输出变量面板 ：显示和编辑节点的输出变量
   * 变量引用提示 ：在输入框中提示可用的变量
   * 变量类型选择 ：支持选择变量类型
   * 默认值设置 ：为变量设置默认值

   ### 12. 执行引擎

   * 变量上下文 ：维护执行时的变量上下文
   * 变量替换 ：在执行前替换所有变量引用
   * 错误处理 ：变量不存在时的错误处理
   * 调试信息 ：显示变量传递的调试信息

   ### 13. UI/UX 增强

   * 变量高亮 ：在节点上显示输入/输出变量
   * 连接提示 ：连接时显示可传递的变量
   * 变量搜索 ：快速查找可用变量
   * 变量预览 ：预览变量值

## 阶段 3: WorkflowInspector 增强

1. 添加"输入变量"配置面板
2. 添加"输出变量"配置面板
3. 支持变量引用语法高亮 `${variable}`

## 阶段 4: 变量传递逻辑

1. 实现变量上下文管理
2. 实现变量解析和替换
3. 实现节点间的数据传递

## 预期效果

* 开始节点可以定义多个输入变量

* 大模型节点可以引用上游变量

* 节点间可以正确传递数据

* Inspector 可以配置所有输入输出变量

