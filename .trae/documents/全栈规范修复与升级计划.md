# 全栈开发规范功能修复与升级计划

基于您提供的“全栈开发规范”和我的审计报告，我制定了以下修复与升级计划。本计划旨在将项目从“基础实现”提升至“生产级规范”。

## 阶段一：核心架构与状态同步（优先解决卡顿与数据不一致）

**目标**：彻底解决前端“刷新不及时”和后端“执行状态不同步”的问题，构建稳定的实时通信基座。

1.  **后端实时网关 (WebSocket)**
    *   引入 `Socket.io` (NestJS Gateway)。
    *   在 `WorkflowRunner` 中集成事件推送，节点状态变更（Running/Success/Error）毫秒级推送到前端。
2.  **前端运行时状态管理 (Pinia)**
    *   重构 `workflow.store.ts`，将分散的执行日志 (`executionLogs`) 和节点状态 (`nodeStatus`) 移入 Store 统一管理。
    *   对接 WebSocket 事件，自动更新 Store 数据，驱动 UI 实时渲染。

## 阶段二：RAG 知识检索系统升级

**目标**：从 SQL 模糊匹配升级为真正的向量语义检索，提升 AI 回答准确率。

1.  **数据库升级 (pgvector)**
    *   修改 `Knowledge` 实体，将 `embedding` 字段类型从 `json` 升级为 `vector(1536)`。
    *   编写数据库迁移脚本，启用 `vector` 扩展。
2.  **检索引擎重构**
    *   重写 `KnowledgeService.search` 方法，使用 `pgvector` 的余弦相似度算子 (`<=>`) 替代 `LIKE`。
    *   实现混合检索逻辑：`Vector Search (语义)` + `Keyword Search (精确)` 加权融合。

## 阶段三：工作流引擎增强与容错

**目标**：完善异常处理和复杂逻辑支持。

1.  **流式传输支持**
    *   为 `AgentService` 和 `WorkflowRunner` 增加流式输出接口（不仅是对话，工作流中的 LLM 节点也支持流式输出）。
2.  **错误处理标准化**
    *   定义统一的业务错误码（`E_WORKFLOW_EXEC_FAILED`, `E_KNOWLEDGE_INDEX_FAILED` 等）。
    *   前端 `ErrorBoundary` 对接新错误码，提供更友好的用户引导（如：Key 过期提示更新配置）。

## 阶段四：验证与测试

1.  **E2E 测试**：编写自动化测试脚本，模拟“上传文档 -> 提问 -> 触发工作流 -> 接收实时响应”的全链路。
2.  **性能测试**：验证 WebSocket 在高并发下的推送延迟。

---

**立即执行建议**：
我建议先从 **阶段一（WebSocket + Pinia）** 开始，因为这是解决您目前体验痛点（页面卡顿、刷新无效）的关键路径。一旦实时性打通，后续的 RAG 升级效果将更容易被验证。