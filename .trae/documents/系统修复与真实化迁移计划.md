# 系统修复与真实化迁移计划

我将为您解决以下四个问题：

1.  **修复部署功能**: 移除前端的 Mock 逻辑，实现真实的后端部署接口。
2.  **修复调试和终端面板**: 确保后端 `WorkflowGateway` 正确推送实时日志，并在前端 `WorkflowService` 中正确监听和更新 UI。
3.  **修复示例工作流显示**: 确认后端种子数据是否正确入库，并确保前端能正确拉取到。
4.  **知识库与对话真实化**: 移除 Mock 数据，连接真实的后端知识库检索和 LLM 对话接口。

---

## 1. 修复部署功能 (Deployment)

目前 `deployWorkflow` 只是在前端 `setTimeout` 模拟成功。我们需要在后端实现真实的部署逻辑（即使只是标记状态）。

*   **后端**:
    *   在 `WorkflowController` 添加 `POST /workflow/:id/deploy` 接口。
    *   在 `WorkflowService` (Backend) 添加 `deploy` 方法，将工作流状态更新为 `published`，并生成一个用于调用的 API Token 或 URL。
*   **前端**:
    *   修改 `workflowService.ts` 中的 `deployWorkflow`，使其发送真实的 API 请求。

## 2. 修复调试与终端 (Debug & Terminal)

调试面板不更新是因为前端没有正确接收或处理 WebSocket 事件，或者后端没有发送。

*   **后端**:
    *   检查 `WorkflowRunner` 中的 `WorkflowGateway` 调用。确保在 `executeNodeWithRetry` 成功或失败时，正确 emit 了 `node-status` 事件。
    *   确保日志包含 `nodeId`, `status`, `outputs`, `error` 等字段。
*   **前端**:
    *   在 `WorkflowService` (Frontend) 中，确保 `socket` 监听了 `node-status` 和 `workflow-log` 事件。
    *   当收到事件时，调用 `addTerminalLog` 和更新 `debugSession`。

## 3. 找回示例工作流 (Example Workflow)

之前创建的 `WorkflowSeedService` 已经运行成功，但在列表中看不到，可能是因为 `browserId` 隔离导致的。

*   **后端**:
    *   修改 `WorkflowService.findAll`。如果查询结果为空，且没有 `browserId` 过滤（或者这是一个新用户），可以返回预置的公共示例工作流（或者将示例工作流的 `browserId` 设为 `null` 或特定公共 ID，并在查询时包含它）。
    *   或者，在 `WorkflowSeedService` 中，不要设置 `browserId`，让它是全局可见的。
    *   **关键点**: 检查 `WorkflowController.findAll` 是否强制加了 `browserId` 过滤，导致看不到公共数据。

## 4. 知识库与对话真实化 (Knowledge & Chat)

目前这些模块可能还是纯前端 Mock。

*   **知识库 (Knowledge)**:
    *   **后端**: 确认 `KnowledgeController` 有 `upload` 和 `search` 接口，且对接了 `pgvector`。
    *   **前端**: 修改 `KnowledgeView.vue`，上传文件时调用 `POST /knowledge/upload`，搜索时调用 `GET /knowledge/search`。
*   **对话 (Chat)**:
    *   **后端**: 确认 `AgentController` (或类似) 有 `chat` 接口，能调用 `WorkflowRunner` 执行包含 `KnowledgeNode` + `LLMNode` 的工作流。
    *   **前端**: 修改 `ChatView.vue`，发送消息时调用真实的后端接口，并支持流式响应 (SSE)。

---

## 执行步骤

1.  **后端**:
    *   修改 `WorkflowController` 和 `WorkflowService` 以支持真实部署。
    *   检查 `findAll` 逻辑以支持公共示例工作流。
    *   确保 `Knowledge` 和 `Chat` 接口可用。
2.  **前端**:
    *   重构 `workflowService.ts`，移除 Mock 的 `deployWorkflow`，对接真实接口。
    *   增强 `socket` 监听逻辑，打通调试面板。
    *   重构 `KnowledgeView` 和 `ChatView` 对接真实 API。
3.  **验证**:
    *   重启服务。
    *   在列表看到示例工作流。
    *   点击“部署”，看到真实请求。
    *   点击“调试”，看到终端日志滚动。
    *   上传文件到知识库，并在对话中进行检索问答。