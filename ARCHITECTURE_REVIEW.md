# Aether Flow æ¶æ„è®¾è®¡å®¡æŸ¥æŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025å¹´
**å®¡æŸ¥èŒƒå›´**: ç³»ç»Ÿæ¶æ„è®¾è®¡
**å®¡æŸ¥æ–¹æ³•**: æ¶æ„åˆ†æ + è®¾è®¡æ¨¡å¼è¯„ä¼° + å¯æ‰©å±•æ€§åˆ†æ
**æ¶æ„è¯„åˆ†**: â­â­â­â­â˜† (3.5/5)

---

## æ‰§è¡Œæ‘˜è¦

Aether Flow é‡‡ç”¨ç°ä»£åŒ–çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œåç«¯ä½¿ç”¨ NestJS æ¡†æ¶ï¼Œå‰ç«¯ä½¿ç”¨ Vue 3ï¼Œæ•´ä½“æ¶æ„è®¾è®¡è¾ƒä¸ºåˆç†ï¼Œä½†åœ¨å¯æ‰©å±•æ€§ã€æ¨¡å—è§£è€¦å’Œè®¾è®¡æ¨¡å¼åº”ç”¨æ–¹é¢ä»æœ‰æ”¹è¿›ç©ºé—´ã€‚

### æ¶æ„è¯„åˆ†è¯¦æƒ…

| è¯„åˆ†é¡¹ | å½“å‰åˆ†æ•° | ç›®æ ‡åˆ†æ•° | è¯„ä»· |
|--------|----------|----------|------|
| æ¨¡å—åˆ’åˆ† | 3.5/5 | 4.5/5 | è¾ƒæ¸…æ™°ï¼Œä½†è€¦åˆåº¦åé«˜ |
| ä¾èµ–æ³¨å…¥ | 4.0/5 | 4.5/5 | ä½¿ç”¨è‰¯å¥½ï¼Œéƒ¨åˆ†ä¸è§„èŒƒ |
| æœåŠ¡å±‚åˆ†ç¦» | 3.5/5 | 4.5/5 | åŸºæœ¬åˆ†ç¦»ï¼Œå¯è¿›ä¸€æ­¥ä¼˜åŒ– |
| æ•°æ®æµè®¾è®¡ | 3.5/5 | 4.5/5 | æ¸…æ™°ï¼Œç¼ºå°‘ç»Ÿä¸€çŠ¶æ€ç®¡ç† |
| SOLID åŸåˆ™ | 3.0/5 | 4.5/5 | éƒ¨åˆ†è¿å |
| è®¾è®¡æ¨¡å¼ | 3.0/5 | 4.0/5 | ä½¿ç”¨ä¸è¶³ |
| å¯æ‰©å±•æ€§ | 2.5/5 | 4.5/5 | æ— æ³•æ°´å¹³æ‰©å±• |
| å¯ç»´æŠ¤æ€§ | 3.5/5 | 4.5/5 | ä¸­ç­‰ |
| **æ€»ä½“è¯„åˆ†** | **3.5/5** | **4.5/5** | **è‰¯å¥½** |

---

## å½“å‰æ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·å±‚ (Browser)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Workflow    â”‚  â”‚    Chat      â”‚  â”‚  Knowledge   â”‚ â”‚
â”‚  â”‚    View      â”‚  â”‚    View      â”‚  â”‚    View      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP/WebSocket
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‰ç«¯ (Vue 3 + Vite)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Components (UI å±‚)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Composables (ä¸šåŠ¡é€»è¾‘å±‚)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Services (API è°ƒç”¨å±‚)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ REST API
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åç«¯ (NestJS + TypeORM)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Controller å±‚ (è·¯ç”±)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Service å±‚ (ä¸šåŠ¡é€»è¾‘)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      Repository/Runner å±‚ (æ•°æ®è®¿é—®/æ‰§è¡Œ)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ SQL/Vector
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®å±‚ (PostgreSQL + pgvector)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Workflow   â”‚  â”‚  Knowledge   â”‚  â”‚   Session    â”‚ â”‚
â”‚  â”‚    Data      â”‚  â”‚    Data      â”‚  â”‚    Data      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

**åç«¯**:
- æ¡†æ¶: NestJS 10.x
- ORM: TypeORM 0.3.x
- æ•°æ®åº“: PostgreSQL 15 + pgvector
- è®¤è¯: JWT + Passport
- WebSocket: @nestjs/websockets
- éªŒè¯: class-validator
- OpenAPI: @nestjs/swagger

**å‰ç«¯**:
- æ¡†æ¶: Vue 3.3.x (Composition API)
- æ„å»ºå·¥å…·: Vite 4.x
- çŠ¶æ€ç®¡ç†: Pinia
- è·¯ç”±: Vue Router 4.x
- HTTP å®¢æˆ·ç«¯: Axios
- UI åº“: Element Plus
- å›¾å½¢åº“: Vue Flow (å·¥ä½œæµç”»å¸ƒ)

**éƒ¨ç½²**:
- å®¹å™¨åŒ–: Docker + Docker Compose
- åå‘ä»£ç†: Nginx
- æ•°æ®åº“: PostgreSQL (å•å®ä¾‹)

---

## æ¶æ„ä¼˜ç‚¹ âœ…

### 1. å‰åç«¯åˆ†ç¦»

```
âœ… ä¼˜ç‚¹:
- å‰åç«¯ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
- æŠ€æœ¯æ ˆçµæ´»
- èŒè´£æ¸…æ™°
- æ˜“äºå›¢é˜Ÿåä½œ
```

### 2. ä½¿ç”¨æˆç†Ÿæ¡†æ¶

```
âœ… NestJS ä¼˜ç‚¹:
- å†…ç½®ä¾èµ–æ³¨å…¥
- æ¨¡å—åŒ–æ¶æ„
- TypeScript åŸç”Ÿæ”¯æŒ
- è£…é¥°å™¨è¯­æ³•ç®€æ´
- ä¼ä¸šçº§æœ€ä½³å®è·µ

âœ… Vue 3 ä¼˜ç‚¹:
- Composition API çµæ´»
- æ€§èƒ½ä¼˜ç§€
- ç”Ÿæ€ç³»ç»Ÿå®Œå–„
- å­¦ä¹ æ›²çº¿å¹³ç¼“
```

### 3. åˆ†å±‚æ¶æ„

```
âœ… åç«¯åˆ†å±‚:
Controller â†’ Service â†’ Repository
- èŒè´£æ¸…æ™°
- æ˜“äºæµ‹è¯•
- ç¬¦åˆ MVC æ¨¡å¼

âœ… å‰ç«¯åˆ†å±‚:
View â†’ Composable â†’ Service
- é€»è¾‘å¤ç”¨
- ç»„ä»¶è§£è€¦
- æ˜“äºç»´æŠ¤
```

### 4. æ¨¡å—åŒ–è®¾è®¡

```
âœ… NestJS æ¨¡å—:
- WorkflowModule
- KnowledgeModule
- AgentModule
- SessionModule
- AuthModule

âœ… ä¼˜ç‚¹:
- åŠŸèƒ½ç‹¬ç«‹
- ä¾èµ–æ¸…æ™°
- æ˜“äºæ‰©å±•
```

---

## æ¶æ„é—®é¢˜ âŒ

### é—®é¢˜ 1: æ— æ³•æ°´å¹³æ‰©å±• âš ï¸ ä¸¥é‡

**é—®é¢˜æè¿°**:
å½“å‰æ¶æ„æ— æ³•æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œåªèƒ½è¿è¡Œå•ä¸ªå®ä¾‹ã€‚

**é—®é¢˜åˆ†æ**:

```
å½“å‰æ¶æ„ï¼ˆå•å®ä¾‹ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backend 1     â”‚ â† å•ç‚¹æ•…éšœ
â”‚  - å†…å­˜ç¼“å­˜      â”‚   æ— æ³•è´Ÿè½½å‡è¡¡
â”‚  - æœ¬åœ° Session  â”‚   æ— æ³•æ°´å¹³æ‰©å±•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   PostgreSQL
```

**é—®é¢˜ç‚¹**:
1. **å†…å­˜ç¼“å­˜æ— æ³•å…±äº«**: `executionCache` å­˜å‚¨åœ¨å†…å­˜ä¸­
2. **Session æ— æ³•å…±äº«**: ç”¨æˆ·ä¼šè¯å­˜å‚¨åœ¨å†…å­˜
3. **æ— åˆ†å¸ƒå¼é”**: å¹¶å‘æ‰§è¡Œå·¥ä½œæµå¯èƒ½å†²çª
4. **æ— ä»»åŠ¡é˜Ÿåˆ—**: é•¿æ—¶é—´ä»»åŠ¡é˜»å¡ API

**å½±å“**:
- ğŸ”´ **å•ç‚¹æ•…éšœ**: æœåŠ¡å™¨å´©æºƒå¯¼è‡´æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- ğŸ”´ **æ— æ³•è´Ÿè½½å‡è¡¡**: æ— æ³•å¢åŠ å®ä¾‹å¤„ç†æ›´å¤šè¯·æ±‚
- ğŸ”´ **æ€§èƒ½ç“¶é¢ˆ**: å•å®ä¾‹å¤„ç†èƒ½åŠ›æœ‰é™
- ğŸ”´ **æ— æ³•æ‰©å®¹**: æ— æ³•åº”å¯¹æµé‡å¢é•¿

**ä¿®å¤å»ºè®®**:

```
æ”¹è¿›æ¶æ„ï¼ˆå¯æ°´å¹³æ‰©å±•ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Backend1  â”‚  Backend2  â”‚  Backend3  â”‚ â† å¤šå®ä¾‹
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Redis å…±äº«çŠ¶æ€  â”‚
         â”‚  - Cache        â”‚ â† ç¼“å­˜ã€Sessionã€é”
         â”‚  - Session      â”‚
         â”‚  - Lock         â”‚
         â”‚  - Queue        â”‚ â† ä»»åŠ¡é˜Ÿåˆ—
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   PostgreSQL    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°æ­¥éª¤**:

1. **ä½¿ç”¨ Redis æ›¿ä»£å†…å­˜ç¼“å­˜**

```typescript
// ç¼“å­˜æ¨¡å—
import { CacheModule } from '@nestjs/cache-manager';
import * as redisStore from 'cache-manager-redis-store';

@Module({
  imports: [
    CacheModule.register({
      store: redisStore,
      host: process.env.REDIS_HOST,
      port: parseInt(process.env.REDIS_PORT),
      ttl: 60,
    }),
  ],
})
export class AppModule {}

// ä½¿ç”¨ç¼“å­˜
@Injectable()
export class WorkflowRunner {
  constructor(@Inject(CACHE_MANAGER) private cacheManager: Cache) {}

  async execute(workflow: Workflow, inputs: Record<string, any>) {
    const cacheKey = `workflow:${workflow.id}:execution`;

    // âœ… ä½¿ç”¨ Redis ç¼“å­˜
    let context = await this.cacheManager.get(cacheKey);
    if (!context) {
      context = { variables: {}, history: [] };
    }

    const result = await this.runNodes(workflow, context);

    // âœ… ç¼“å­˜åˆ° Redisï¼ˆå¤šå®ä¾‹å…±äº«ï¼‰
    await this.cacheManager.set(cacheKey, context, 600);

    return result;
  }
}
```

2. **ä½¿ç”¨ Redis å­˜å‚¨ Session**

```typescript
// session.module.ts
import * as session from 'express-session';
import * as RedisStore from 'connect-redis';
import { createClient } from 'redis';

@Injectable()
export class SessionService {
  private redisClient = createClient({
    socket: {
      host: process.env.REDIS_HOST,
      port: parseInt(process.env.REDIS_PORT),
    },
  });

  async onModuleInit() {
    await this.redisClient.connect();
  }

  getSessionMiddleware() {
    const RedisStore = RedisStore(session);
    return session({
      store: new RedisStore({
        client: this.redisClient,
      }),
      secret: process.env.SESSION_SECRET,
      resave: false,
      saveUninitialized: false,
      cookie: {
        maxAge: 30 * 24 * 60 * 60 * 1000, // 30 å¤©
      },
    });
  }
}
```

3. **ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”**

```typescript
// distributed-lock.service.ts
import { Injectable } from '@nestjs/common';
import { InjectRedis } from '@liaoliaots/nestjs-redis';
import Redis from 'ioredis';

@Injectable()
export class DistributedLockService {
  constructor(@InjectRedis() private redis: Redis) {}

  async acquireLock(lockKey: string, ttl: number = 10000): Promise<boolean> {
    const result = await this.redis.set(
      lockKey,
      'locked',
      'PX',
      ttl,
      'NX' // åªåœ¨ä¸å­˜åœ¨æ—¶è®¾ç½®
    );

    return result === 'OK';
  }

  async releaseLock(lockKey: string): Promise<void> {
    await this.redis.del(lockKey);
  }

  async withLock<T>(
    lockKey: string,
    callback: () => Promise<T>,
    ttl: number = 10000
  ): Promise<T> {
    const acquired = await this.acquireLock(lockKey, ttl);

    if (!acquired) {
      throw new Error(`Failed to acquire lock: ${lockKey}`);
    }

    try {
      return await callback();
    } finally {
      await this.releaseLock(lockKey);
    }
  }
}

// ä½¿ç”¨åˆ†å¸ƒå¼é”
@Injectable()
export class WorkflowService {
  constructor(private lockService: DistributedLockService) {}

  async execute(workflowId: string) {
    const lockKey = `workflow:execute:${workflowId}`;

    return await this.lockService.withLock(lockKey, async () => {
      // âœ… åŒä¸€å·¥ä½œæµä¸ä¼šåœ¨å¤šä¸ªå®ä¾‹åŒæ—¶æ‰§è¡Œ
      return await this.runWorkflow(workflowId);
    });
  }
}
```

4. **ä½¿ç”¨ Bull Queue ä»»åŠ¡é˜Ÿåˆ—**

```typescript
// queue.module.ts
import { BullModule } from '@nestjs/bull';

@Module({
  imports: [
    BullModule.forRoot({
      redis: {
        host: process.env.REDIS_HOST,
        port: parseInt(process.env.REDIS_PORT),
      },
    }),
    BullModule.registerQueue({
      name: 'workflow',
      defaultJobOptions: {
        attempts: 3,
        backoff: {
          type: 'exponential',
          delay: 1000,
        },
      },
    }),
  ],
})
export class QueueModule {}

// workflow.service.ts
@Injectable()
export class WorkflowService {
  constructor(@InjectQueue('workflow') private workflowQueue: Queue) {}

  async execute(workflowId: string, inputs: Record<string, any>) {
    // âœ… æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œä¸é˜»å¡ API
    const job = await this.workflowQueue.add('execute', {
      workflowId,
      inputs
    });

    return { jobId: job.id, status: 'queued' };
  }

  // âœ… å¤„ç†é˜Ÿåˆ—ä»»åŠ¡
  @Process('execute')
  async handleExecute(job: Job) {
    const { workflowId, inputs } = job.data;

    try {
      const result = await this.runWorkflow(workflowId, inputs);
      return result;
    } catch (error) {
      throw error;
    }
  }
}
```

**ä¿®å¤ä¼˜å…ˆçº§**: P1 - 1-2 å‘¨
**ä¿®å¤å·¥ä½œé‡**: 40-60 å°æ—¶

---

### é—®é¢˜ 2: æ¨¡å—è€¦åˆåº¦é«˜

**é—®é¢˜æè¿°**:
éƒ¨åˆ†æ¨¡å—ä¹‹é—´å­˜åœ¨ç´§å¯†è€¦åˆï¼Œå½±å“ç‹¬ç«‹æ€§å’Œå¯æµ‹è¯•æ€§ã€‚

**é—®é¢˜ç¤ºä¾‹**:

```typescript
// âŒ WorkflowService ç›´æ¥ä¾èµ–å¤šä¸ªæœåŠ¡
@Injectable()
export class WorkflowService {
  constructor(
    private workflowRepository: Repository<Workflow>,
    private nodeService: NodeService, // âœ… åˆç†
    private edgeService: EdgeService, // âœ… åˆç†
    private agentService: AgentService, // âŒ è€¦åˆåº¦é«˜
    private knowledgeService: KnowledgeService, // âŒ è€¦åˆåº¦é«˜
    private executionService: ExecutionService, // âŒ è€¦åˆåº¦é«˜
  ) {}

  async execute(workflow: Workflow) {
    // âŒ WorkflowService éœ€è¦äº†è§£æ‰€æœ‰æœåŠ¡
    for (const node of workflow.nodes) {
      switch (node.type) {
        case 'llm':
          return await this.agentService.chat(node.config);
        case 'knowledge':
          return await this.knowledgeService.search(node.config);
        // ...
      }
    }
  }
}
```

**ä¿®å¤å»ºè®®**:

```typescript
// âœ… ä½¿ç”¨ç­–ç•¥æ¨¡å¼è§£è€¦
interface NodeStrategy {
  execute(config: any, inputs: any): Promise<any>;
}

@Injectable()
export class LlmNodeStrategy implements NodeStrategy {
  constructor(private agentService: AgentService) {}

  async execute(config: any, inputs: any): Promise<any> {
    return await this.agentService.chat(config, inputs);
  }
}

@Injectable()
export class KnowledgeNodeStrategy implements NodeStrategy {
  constructor(private knowledgeService: KnowledgeService) {}

  async execute(config: any, inputs: any): Promise<any> {
    return await this.knowledgeService.search(config, inputs);
  }
}

@Injectable()
export class NodeStrategyRegistry {
  private strategies = new Map<string, NodeStrategy>();

  register(type: string, strategy: NodeStrategy) {
    this.strategies.set(type, strategy);
  }

  get(type: string): NodeStrategy {
    const strategy = this.strategies.get(type);
    if (!strategy) {
      throw new Error(`No strategy found for node type: ${type}`);
    }
    return strategy;
  }
}

// âœ… WorkflowService åªä¾èµ–ç­–ç•¥æ³¨å†Œè¡¨
@Injectable()
export class WorkflowService {
  constructor(
    private workflowRepository: Repository<Workflow>,
    private strategyRegistry: NodeStrategyRegistry, // âœ… å•ä¸€ä¾èµ–
  ) {}

  async execute(workflow: Workflow) {
    for (const node of workflow.nodes) {
      const strategy = this.strategyRegistry.get(node.type);
      const result = await strategy.execute(node.config, inputs);
    }
  }
}
```

**ä¿®å¤ä¼˜å…ˆçº§**: P2 - 1 ä¸ªæœˆ
**ä¿®å¤å·¥ä½œé‡**: 20-30 å°æ—¶

---

### é—®é¢˜ 3: ç¼ºå°‘ç»Ÿä¸€çŠ¶æ€ç®¡ç†

**é—®é¢˜æè¿°**:
å‰ç«¯ç¼ºå°‘ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œæ•°æ®æµä¸æ¸…æ™°ã€‚

**é—®é¢˜ç¤ºä¾‹**:

```vue
<script setup lang="ts">
// âŒ æ¯ä¸ªç»„ä»¶è‡ªå·±ç®¡ç†çŠ¶æ€
const workflows = ref([]);

// âŒ çˆ¶å­ç»„ä»¶ä¼ é€’ props/emits å¤æ‚
// âŒ å…„å¼Ÿç»„ä»¶é€šä¿¡å›°éš¾
// âŒ è·¨é¡µé¢çŠ¶æ€å…±äº«å›°éš¾
</script>
```

**ä¿®å¤å»ºè®®**:

```typescript
// stores/workflow.store.ts
import { defineStore } from 'pinia';

export const useWorkflowStore = defineStore('workflow', {
  state: () => ({
    workflows: [] as Workflow[],
    selectedWorkflowId: null as string | null,
    loading: false,
    error: null as string | null,
  }),

  getters: {
    selectedWorkflow: (state) => {
      return state.workflows.find(w => w.id === state.selectedWorkflowId) || null;
    },

    publishedWorkflows: (state) => {
      return state.workflows.filter(w => w.status === 'published');
    },
  },

  actions: {
    async loadWorkflows() {
      this.loading = true;
      this.error = null;

      try {
        this.workflows = await workflowService.findAll();
      } catch (error) {
        this.error = 'Failed to load workflows';
        console.error(error);
      } finally {
        this.loading = false;
      }
    },

    async createWorkflow(data: CreateWorkflowDto) {
      const workflow = await workflowService.create(data);
      this.workflows.push(workflow);
      return workflow;
    },

    async updateWorkflow(id: string, data: Partial<Workflow>) {
      const updated = await workflowService.update(id, data);
      const index = this.workflows.findIndex(w => w.id === id);
      if (index !== -1) {
        this.workflows[index] = updated;
      }
      return updated;
    },

    async deleteWorkflow(id: string) {
      await workflowService.delete(id);
      this.workflows = this.workflows.filter(w => w.id !== id);
    },

    selectWorkflow(id: string) {
      this.selectedWorkflowId = id;
    },
  },
});
```

```vue
<!-- âœ… ç»„ä»¶ä½¿ç”¨ store -->
<script setup lang="ts">
import { useWorkflowStore } from '@/stores/workflow.store';
import { storeToRefs } from 'pinia';

const workflowStore = useWorkflowStore();
const { workflows, selectedWorkflow, loading } = storeToRefs(workflowStore);

// âœ… ç›´æ¥è°ƒç”¨ actions
onMounted(() => {
  workflowStore.loadWorkflows();
});
</script>

<template>
  <div>
    <div v-if="loading">Loading...</div>
    <div v-else>
      <div v-for="workflow in workflows" :key="workflow.id">
        {{ workflow.name }}
      </div>
    </div>
  </div>
</template>
```

**ä¿®å¤ä¼˜å…ˆçº§**: P2 - 1 ä¸ªæœˆ
**ä¿®å¤å·¥ä½œé‡**: 16-20 å°æ—¶

---

### é—®é¢˜ 4: è®¾è®¡æ¨¡å¼åº”ç”¨ä¸è¶³

**é—®é¢˜æè¿°**:
ä»£ç ä¸­è®¾è®¡æ¨¡å¼åº”ç”¨ä¸è¶³ï¼Œå­˜åœ¨é‡å¤ä»£ç å’Œç¡¬ç¼–ç ã€‚

**é—®é¢˜ç¤ºä¾‹**:

```typescript
// âŒ ç¡¬ç¼–ç èŠ‚ç‚¹ç±»å‹åˆ¤æ–­
switch (node.type) {
  case 'start':
    return new StartNode();
  case 'llm':
    return new LlmNode();
  case 'knowledge':
    return new KnowledgeNode();
  case 'delay':
    return new DelayNode();
  // ... æ¯æ¬¡æ–°å¢èŠ‚ç‚¹éƒ½è¦ä¿®æ”¹è¿™é‡Œ
}
```

**ä¿®å¤å»ºè®®**:

```typescript
// âœ… ä½¿ç”¨å·¥å‚æ¨¡å¼ + æ³¨å†Œè¡¨
interface NodeFactory {
  create(): BaseNode;
}

class NodeFactoryRegistry {
  private factories = new Map<string, NodeFactory>();

  register(type: string, factory: NodeFactory) {
    this.factories.set(type, factory);
  }

  create(type: string): BaseNode {
    const factory = this.factories.get(type);
    if (!factory) {
      throw new Error(`Unknown node type: ${type}`);
    }
    return factory.create();
  }
}

// âœ… è£…é¥°å™¨è‡ªåŠ¨æ³¨å†Œ
export function RegisterNode(type: string) {
  return function (constructor: new () => BaseNode) {
    const factory: NodeFactory = {
      create: () => new constructor(),
    };
    nodeRegistry.register(type, factory);
  };
}

// âœ… ä½¿ç”¨è£…é¥°å™¨
@RegisterNode('start')
export class StartNode extends BaseNode {
  type = 'start';
  // ...
}

@RegisterNode('llm')
export class LlmNode extends BaseNode {
  type = 'llm';
  // ...
}

// âœ… åŠ¨æ€åˆ›å»ºèŠ‚ç‚¹
const node = nodeRegistry.create(nodeType);
```

**ä¿®å¤ä¼˜å…ˆçº§**: P2 - 1 ä¸ªæœˆ
**ä¿®å¤å·¥ä½œé‡**: 12-16 å°æ—¶

---

## æ¶æ„ä¼˜åŒ–è·¯çº¿å›¾

### çŸ­æœŸï¼ˆ1-2 ä¸ªæœˆï¼‰

1. **âœ… æ·»åŠ  Redis ç¼“å­˜å±‚**
   - æ›¿ä»£å†…å­˜ç¼“å­˜
   - å®ç°ç¼“å­˜å…±äº«

2. **âœ… å®ç°ä»»åŠ¡é˜Ÿåˆ—**
   - é›†æˆ Bull Queue
   - å¼‚æ­¥å¤„ç†é•¿æ—¶é—´ä»»åŠ¡

3. **âœ… æ·»åŠ åˆ†å¸ƒå¼é”**
   - é˜²æ­¢å¹¶å‘å†²çª
   - å®ç°äº’æ–¥è®¿é—®

4. **âœ… å‰ç«¯çŠ¶æ€ç®¡ç†**
   - ä½¿ç”¨ Pinia
   - ç»Ÿä¸€æ•°æ®æµ

### ä¸­æœŸï¼ˆ2-4 ä¸ªæœˆï¼‰

1. **âœ… æ¨¡å—è§£è€¦**
   - ä½¿ç”¨ç­–ç•¥æ¨¡å¼
   - é™ä½è€¦åˆåº¦

2. **âœ… è®¾è®¡æ¨¡å¼åº”ç”¨**
   - å·¥å‚æ¨¡å¼
   - è£…é¥°å™¨æ¨¡å¼
   - è§‚å¯Ÿè€…æ¨¡å¼

3. **âœ… API ç½‘å…³**
   - ç»Ÿä¸€å…¥å£
   - è·¯ç”±å’Œè´Ÿè½½å‡è¡¡

4. **âœ… æœåŠ¡æ‹†åˆ†**
   - å·¥ä½œæµæœåŠ¡
   - çŸ¥è¯†åº“æœåŠ¡
   - å¯¹è¯æœåŠ¡

### é•¿æœŸï¼ˆ4-6 ä¸ªæœˆï¼‰

1. **âœ… å¾®æœåŠ¡æ¶æ„**
   - æœåŠ¡ç‹¬ç«‹éƒ¨ç½²
   - æœåŠ¡é—´é€šä¿¡

2. **âœ… äº‹ä»¶é©±åŠ¨æ¶æ„**
   - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
   - å¼‚æ­¥äº‹ä»¶å¤„ç†

3. **âœ… æœåŠ¡ç½‘æ ¼**
   - Istio
   - æœåŠ¡æ²»ç†

4. **âœ… äº‘åŸç”Ÿéƒ¨ç½²**
   - Kubernetes
   - è‡ªåŠ¨æ‰©ç¼©å®¹

---

## é™„å½•

### A. æ¶æ„å†³ç­–è®°å½• (ADR)

| å†³ç­– | èƒŒæ™¯ | é€‰æ‹© | åŸå›  | çŠ¶æ€ |
|------|------|------|------|------|
| å‰ç«¯æ¡†æ¶ | éœ€è¦å“åº”å¼ UI | Vue 3 | å­¦ä¹ æ›²çº¿ä½ï¼Œæ€§èƒ½å¥½ | âœ… å·²é‡‡ç”¨ |
| åç«¯æ¡†æ¶ | éœ€è¦ä¼ä¸šçº§æ¶æ„ | NestJS | TypeScript åŸç”Ÿï¼Œæ¨¡å—åŒ– | âœ… å·²é‡‡ç”¨ |
| æ•°æ®åº“ | éœ€è¦å‘é‡æœç´¢ | PostgreSQL + pgvector | æˆç†Ÿï¼Œæ”¯æŒå‘é‡ | âœ… å·²é‡‡ç”¨ |
| çŠ¶æ€ç®¡ç† | éœ€è¦å…¨å±€çŠ¶æ€ | Pinia | Vue 3 å®˜æ–¹æ¨è | âœ… å·²é‡‡ç”¨ |
| ç¼“å­˜ç­–ç•¥ | éœ€è¦å…±äº«ç¼“å­˜ | Redis | é«˜æ€§èƒ½ï¼Œæ”¯æŒåˆ†å¸ƒå¼ | ğŸ”„ è®¡åˆ’ä¸­ |
| ä»»åŠ¡é˜Ÿåˆ— | éœ€è¦å¼‚æ­¥å¤„ç† | Bull Queue | Redis æ”¯æŒï¼Œæ˜“ç”¨ | ğŸ”„ è®¡åˆ’ä¸­ |
| å®¹å™¨åŒ– | éœ€è¦éƒ¨ç½²ä¸€è‡´æ€§ | Docker | æ ‡å‡†åŒ–éƒ¨ç½² | âœ… å·²é‡‡ç”¨ |

### B. æ¶æ„åŸåˆ™

1. **å•ä¸€èŒè´£åŸåˆ™**: æ¯ä¸ªæ¨¡å—/ç»„ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
3. **ä¾èµ–å€’ç½®**: ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
4. **æ¥å£éš”ç¦»**: ç»†ç²’åº¦æ¥å£ï¼Œé¿å…ä¸å¿…è¦ä¾èµ–
5. **æœ€å°‘çŸ¥è¯†**: æ¨¡å—é—´æœ€å°åŒ–é€šä¿¡
6. **å…³æ³¨ç‚¹åˆ†ç¦»**: UIã€ä¸šåŠ¡é€»è¾‘ã€æ•°æ®è®¿é—®åˆ†ç¦»

---

**æŠ¥å‘Šç»“æŸ**

æ‰€æœ‰æ¶æ„æ”¹è¿›å»ºè®®å·²åœ¨ [IMPROVEMENT_RECOMMENDATIONS.md](./IMPROVEMENT_RECOMMENDATIONS.md) ä¸­æ±‡æ€»ã€‚
